# RAG Question-Reference-Answer (QRA) Pipeline

This pipeline is designed to generate Question-Reference-Answer (QRA) triples based on configuration files and documents. It supports multiple domains and languages, providing scripts for specific domain handling.

## Setup and Usage

### 1. Navigate to the `qra_generation` Folder

Change your current directory to the `qra_generation` folder by running:

```bash
cd rageval/qra_generation
```

### 2. Install Dependencies

Before running the scripts, install all required dependencies:

```bash
pip install -r requirements.txt
```

### 3. Set `OpenAI_API_KEY`

Ensure that your `OpenAI_API_KEY` is correctly set in the `.env` file.

### 4. Prepare Input Data

Place the generated articles and configuration files in the `data` folder.

### 5. QRA Generation

The `scripts` directory contains scripts for generating QRA triples across different domains. To generate QRA triples for a single document, configure the parameters in `run_qra_single_doc.sh`:

- **`MODEL_NAME`**: The OpenAI model name to use (default: `gpt-4o`)
- **`DOMAIN`**: The domains requiring reference refinement (default: `finance`)
- **`LANGUAGES`**: The languages for reference refinement (default: `zh`)
- **`INPUT_DIR`**: Path to the input data folder (example: `"data/law/en/config"`)
- **`OUTPUT_DIR`**: Path to the output data folder (example: `"output/law/en/config"`)
- **`JSON_IDX`**: Index of the JSON files for each topic (default: `0`)

For generating QRA triples across multiple documents, use `run_qra_multi_doc.sh` and set:

- **`NUMBER`**: The number of multi-documents to generate (default: `1`)

To generate irrelevant or unanswerable questions for the law and medical domains, use `run_irrelevant.sh`. The parameter `NUMBER` means the number of irrelevant ubanswerable question.

Run the scripts with the same format as follows:

```bash
bash scripts/run_qra_single_doc.sh
```

```bash
bash scripts/run_qra_multi_doc.sh
```

```bash
bash scripts/run_qra_irrelevant.sh
```

The intermediate generated results will be placed in the `output` folder.

### 6. Reference Refinement

Some references generated by the model may not match the original articles. To refine these references, use the script `run_reference_refinement.sh` with the following parameters:

- **`DOMAINS`**: The domains requiring reference refinement (default: `finance, law, medical`)
- **`LANGUAGES`**: The languages for reference refinement (default: `zh, en`)
- **`MODEL_NAME`**: The OpenAI model name to use (default: `gpt-4o`)
- **`TYPE`**: Type of reference refinement, either 'single_doc' or 'multi_doc' (default: `single_doc`)

Run the command:

```bash
bash scripts/run_reference_refinement.sh
```

The refined results will be stored in the same folder `output` folder.

### 7. Aggregate Articles and Queries

To aggregate articles and queries, use `run_corporation.sh` with:

- **`OUTPUT_DIR`**: Path to the output JSONL folder (default: `results`)

- **`DOMAINS`**: The domains requiring reference refinement (default: `finance, law, medical`)
- **`LANGUAGES`**: The languages for reference refinement (default: `zh, en`)
- **`TYPE`**: Type of corporation, either 'qra' or 'doc' (default: `qra`)

Run the command:

```bash
bash scripts/run_corporation.sh
```

The aggregated articles and queries JSONL files will be stored in the `results` folder.

### 8. Keypoints Generation

For generating keypoints, use `run.sh` with:

- **`MODEL_NAME`**: The OpenAI model name to use (default: `"gpt-4o"`)
- **`INPUT_FILE_PATH`**: Path to the input JSONL file (default: `"results/DRAGONBALL_queries.jsonl"`)
- **`OUTPUT_DIR`**: Path to the output JSONL folder (default: `"results/DRAGONBALL_queries.jsonl"`)

Run the script:

```bash
bash scripts/run_keypoint_generation.sh
```

Our prompts place in the `prompts` folder.
